{% extends "base.html" %}
{% block title %}Search - Troveing{% endblock %}
{% block page_title %}Search Trove Archives{% endblock %}
{% block content %}
<div class="search-layout">
  <!-- Left Filters Panel -->
  <aside class="filters-panel">
    <div class="filters-header">
      <h2>Filters</h2>
      {% if applied_filters %}
      <button type="button" class="btn-clear-all" onclick="clearAllFilters()">Clear All</button>
      {% endif %}
    </div>
    
    <form method="get" id="searchForm" class="filters-form">
      <input type="hidden" id="categoryField" name="category" value="{{ category or 'newspaper' }}">
      
      <!-- Category Selection (moved from main area) -->
      <div class="filter-section">
        <div class="filter-section-header">
          <label class="filter-label">Category</label>
        </div>
        <div class="category-pills-compact" role="tablist">
          {% for option in category_options %}
          <button type="button"
                  class="category-pill-compact{% if option.id == category %} is-active{% endif %}"
                  onclick="switchCategory('{{ option.id }}')">
            {{ option.label }}
          </button>
          {% endfor %}
        </div>
      </div>
      
      <!-- Date/Time Filters -->
      <div class="filter-section">
        <div class="filter-section-header">
          <label class="filter-label">ğŸ“… Date Range</label>
        </div>
        <div class="year-inputs">
          <input type="number" name="year_from" id="year_from" value="{{ year_from or '' }}" 
                 placeholder="From" min="1800" max="2024" class="year-input"
                 onfocus="showQuickChips('year-chips')" onblur="setTimeout(() => hideQuickChips('year-chips'), 200)">
          <span class="year-separator">â€“</span>
          <input type="number" name="year_to" id="year_to" value="{{ year_to or '' }}" 
                 placeholder="To" min="1800" max="2024" class="year-input"
                 onfocus="showQuickChips('year-chips')" onblur="setTimeout(() => hideQuickChips('year-chips'), 200)">
        </div>
        <div class="quick-chip-container" id="year-chips" style="display: none;">
          {% if filter_suggestions.date_presets %}
          <div class="quick-chip-row" aria-label="Quick date ranges">
            {% for preset in filter_suggestions.date_presets %}
            {% if loop.index <= 4 %}
            <button type="button" class="quick-chip" onclick="applyDatePreset({{ preset.year_from }}, {{ preset.year_to }})">
              {{ preset.label }}
            </button>
            {% endif %}
            {% endfor %}
          </div>
          {% endif %}
          {% if filter_suggestions.decades %}
          <div class="quick-chip-row" aria-label="Quick decade filters">
            {% for decade in filter_suggestions.decades %}
            {% if loop.index <= 4 %}
            <button type="button" class="quick-chip" onclick="applyDatePreset({{ decade.year_from }}, {{ decade.year_to }})">
              {{ decade.label }}
            </button>
            {% endif %}
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Location Filters -->
      <div class="filter-section">
        <div class="filter-section-header">
          <label class="filter-label">ğŸ“ Location</label>
        </div>
        <input type="text" name="l_place" id="l_place" value="{{ l_place or '' }}" 
               placeholder="e.g. Sydney, NSW" class="filter-input" 
               list="place-suggestions"
               onfocus="showQuickChips('place-chips')" onblur="setTimeout(() => hideQuickChips('place-chips'), 200)"
               onchange="submitFilters()">
        <div class="quick-chip-container" id="place-chips" style="display: none;">
          {% if filter_suggestions.places %}
          <div class="quick-chip-row" aria-label="Popular places">
            {% for place_option in filter_suggestions.places %}
            {% if loop.index <= 4 %}
            <button type="button" class="quick-chip" data-value="{{ place_option }}" onclick="applyFilterValue('l_place', this.dataset.value)">
              {{ place_option }}
            </button>
            {% endif %}
            {% endfor %}
            {% if filter_suggestions.places|length > 4 %}
            <button type="button" class="quick-chip quick-chip-more" onclick="expandChips('place-chips', {{ filter_suggestions.places|length }})">
              +{{ filter_suggestions.places|length - 4 }} more
            </button>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Publication Filter -->
      <div class="filter-section">
        <div class="filter-section-header">
          <label class="filter-label">ğŸ“° Publication</label>
        </div>
        <input type="text" name="publication" id="publication" value="{{ publication or '' }}" 
               placeholder="Newspaper name" class="filter-input" list="publication-suggestions"
               onfocus="showQuickChips('publication-chips')" onblur="setTimeout(() => hideQuickChips('publication-chips'), 200)"
               onchange="submitFilters()">
        <div class="quick-chip-container" id="publication-chips" style="display: none;">
          {% if filter_suggestions.publications %}
          <div class="quick-chip-row" aria-label="Popular publications">
            {% for publication_option in filter_suggestions.publications %}
            {% if loop.index <= 4 %}
            <button type="button" class="quick-chip" data-value="{{ publication_option }}" onclick="applyFilterValue('publication', this.dataset.value)">
              {{ publication_option }}
            </button>
            {% endif %}
            {% endfor %}
            {% if filter_suggestions.publications|length > 4 %}
            <button type="button" class="quick-chip quick-chip-more" onclick="expandChips('publication-chips', {{ filter_suggestions.publications|length }})">
              +{{ filter_suggestions.publications|length - 4 }} more
            </button>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Format & Sort (always visible) -->
      <div class="filter-section">
        <div class="filter-section-header">
          <label class="filter-label">ğŸ“„ Format</label>
        </div>
        <select name="l_format" id="l_format" class="filter-select" onchange="submitFilters()">
          <option value="">All Formats</option>
          <option value="Article" {{ "selected" if l_format=="Article" else "" }}>Article</option>
          <option value="Newspaper" {{ "selected" if l_format=="Newspaper" else "" }}>Newspaper</option>
          <option value="Book" {{ "selected" if l_format=="Book" else "" }}>Book</option>
          <option value="Image" {{ "selected" if l_format=="Image" else "" }}>Image</option>
        </select>
        <div class="quick-chip-container" id="format-chips" style="display: none;">
          {% if filter_suggestions.formats %}
          <div class="quick-chip-row" aria-label="Popular formats">
            {% for format_option in filter_suggestions.formats %}
            {% if loop.index <= 4 %}
            <button type="button" class="quick-chip" data-value="{{ format_option.value }}" onclick="applyFormat(this.dataset.value)">
              {{ format_option.label }}
            </button>
            {% endif %}
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
      
      <div class="filter-section">
        <div class="filter-section-header">
          <label class="filter-label">ğŸ”€ Sort</label>
        </div>
        <select name="sortby" id="sortby" class="filter-select" onchange="submitFilters()">
          <option value="">Relevance</option>
          <option value="dateAsc" {{ "selected" if sortby=="dateAsc" else "" }}>Date â†‘ Oldest</option>
          <option value="dateDesc" {{ "selected" if sortby=="dateDesc" else "" }}>Date â†“ Newest</option>
        </select>
      </div>
      
      <!-- Advanced Filters (collapsible) -->
      <div class="filter-section filter-section-collapsible">
        <button type="button" class="filter-section-toggle" onclick="toggleFilterSection(this)" aria-expanded="false">
          <span class="filter-label">âš™ï¸ Advanced</span>
          <span class="toggle-icon">â–¼</span>
        </button>
        <div class="filter-section-content" style="display: none;">
          <div class="filter-group">
            <label class="filter-label">People/Orgs</label>
            <input type="text" name="people_orgs" id="people_orgs" value="{{ people_orgs or '' }}" 
                   placeholder="Person or organization" class="filter-input" onchange="submitFilters()">
          </div>
          <div class="filter-group">
            <label class="filter-label">Keywords</label>
            <input type="text" name="keywords" id="keywords" value="{{ keywords or '' }}" 
                   placeholder="Additional keywords" class="filter-input" onchange="submitFilters()">
          </div>
        </div>
      </div>

      <datalist id="place-suggestions">
        {% for place_option in filter_suggestions.places %}
        <option value="{{ place_option }}">
        {% endfor %}
      </datalist>

      <datalist id="publication-suggestions">
        {% for publication_option in filter_suggestions.publications %}
        <option value="{{ publication_option }}">
        {% endfor %}
      </datalist>
    </form>
  </aside>
  
  <!-- Center Result Stream -->
  <main class="results-main">
    <div class="search-header">
      <form method="get" class="search-form-main" onsubmit="return handleSearch(event)">
        <input type="text" name="q" id="searchQuery" value="{{ q or '' }}" 
               placeholder="Search Trove archives... (natural language supported)" 
               class="search-input-main" autofocus>
        <button type="submit" class="btn-search-main">ğŸ” Search</button>
        {% if q %}
        <a href="/research?seed={{ q|urlencode }}" class="btn-research-link" title="Start deep research on this query">ğŸ” Deep Research</a>
        {% endif %}
      </form>
      {% if q %}
      <div class="search-info">
        <span class="result-count">{{ total }} results</span>
        {% if items %}
        <span class="result-range">Showing {{ s + 1 }}-{{ [s + n, total]|min }} of {{ total }}</span>
        {% endif %}
      </div>
      {% endif %}
    </div>

    {% if applied_filters %}
    <div class="active-filters" aria-label="Active filters">
      <span class="active-filters__label">Active filters:</span>
      {% for active in applied_filters %}
      <button type="button" class="active-filter-chip" onclick="removeFilter('{{ active.key }}')">
        {{ active.label }} <span aria-hidden="true">Ã—</span>
      </button>
      {% endfor %}
      <button type="button" class="active-filter-reset" onclick="clearAllFilters()">Clear all</button>
    </div>
    {% endif %}

    <div class="results-stream" id="resultsStream">
      {% if items %}
        {% for item in items %}
        <article class="result-card" data-id="{{ item.id }}" data-title="{{ item.title }}" data-date="{{ item.date or '' }}" data-source="{{ item.source or '' }}" onclick="selectResult('{{ item.id }}')">
          {% if item.thumbnail %}
          <div class="result-thumbnail">
            <img src="{{ item.thumbnail }}" alt="Thumbnail" loading="lazy" 
                 onerror="handleThumbnailError(this, '{{ item.url or '' }}', '{{ item.thumbnail or '' }}')"
                 onload="handleThumbnailLoad(this)">
          </div>
          {% elif item.url %}
          <div class="result-thumbnail">
            <img src="{{ item.url }}/image?hei=180" alt="Thumbnail" loading="lazy" 
                 onerror="handleThumbnailError(this, '{{ item.url }}', '')"
                 onload="handleThumbnailLoad(this)">
          </div>
          {% endif %}
          <div class="result-content">
            <h3 class="result-title">{{ item.title }}</h3>
            <div class="result-meta">
              {% if item.date %}
              <span class="result-date">ğŸ“… {{ item.date }}</span>
              {% endif %}
              {% if item.source %}
              <span class="result-source">ğŸ“° {{ item.source }}</span>
              {% endif %}
            </div>
            {% if item.snippet %}
            <p class="result-snippet" data-read-aloud="{{ item.snippet|replace('"', '&quot;') }}">{{ item.snippet|safe }}</p>
            {% endif %}
            <div class="result-actions">
              <button class="btn-action btn-pin" onclick="event.stopPropagation(); togglePin('{{ item.id }}', this)" title="Pin for citation" data-pinned="false">
                <span class="pin-icon">ğŸ“Œ</span>
              </button>
              <button class="btn-action btn-read-aloud" onclick="event.stopPropagation(); readAloudResult('{{ item.id }}')" title="Read Aloud (Space)">
                <span class="read-icon">ğŸ”Š</span>
              </button>
              <button class="btn-action" onclick="event.stopPropagation(); addToCollection('{{ item.id }}')" title="Add to Collection">
                ğŸ“š
              </button>
              <button class="btn-action" onclick="event.stopPropagation(); openReader('{{ item.id }}', '{{ item.url or '' }}', '{{ (item.snippet or '')[:500]|replace("'", "\\'")|replace('"', '&quot;') }}', '{{ (item.title or '')|replace("'", "\\'")|replace('"', '&quot;') }}', '{{ item.date or '' }}', '{{ (item.source or '')|replace("'", "\\'")|replace('"', '&quot;') }}')" title="Open Reader (r)">
                ğŸ“–
              </button>
              {% if item.url %}
              <a href="{{ item.url }}" target="_blank" class="btn-action" onclick="event.stopPropagation()" title="View on Trove">
                ğŸ”—
              </a>
              {% endif %}
            </div>
          </div>
        </article>
        {% endfor %}
        
        {% if total > n %}
        <div class="pagination">
          {% if s > 0 %}
          <a href="?{{ query_string|replace('s=' + s|string, 's=' + (s - n)|string) }}" class="btn-pagination">â† Previous</a>
          {% endif %}
          {% if s + n < total %}
          <a href="?{{ query_string|replace('s=' + s|string, 's=' + (s + n)|string) }}" class="btn-pagination">Next â†’</a>
          {% endif %}
        </div>
        {% endif %}
      {% elif q %}
        <div class="no-results">
          <p>No results found for "{{ q }}"</p>
          <p class="no-results-hint">Try adjusting your filters or search terms.</p>
        </div>
      {% else %}
        <div class="search-prompt">
          <h2>Search Trove Archives</h2>
          <p>Enter a natural language query to search across Trove and configured archives.</p>
          <p class="search-hint">Example: "Indigenous accounts around colonisation in New South Wales, 1850â€“1910"</p>
        </div>
      {% endif %}
    </div>
  </main>
  
  <!-- Right Preview Drawer -->
  <aside class="preview-drawer" id="previewDrawer">
    <div class="drawer-header">
      <h3>Preview</h3>
      <button class="btn-drawer-close" onclick="closePreview()">Ã—</button>
    </div>
    <div class="drawer-content" id="drawerContent">
      <p class="drawer-placeholder">Select a result to preview</p>
    </div>
  </aside>
</div>

<script>
let selectedResultId = null;

// Thumbnail error handling with fallback URLs
function handleThumbnailError(img, itemUrl, originalThumbnail) {
  // Prevent infinite loop
  if (img.dataset.errorHandled === 'true') {
    showThumbnailPlaceholder(img);
    return;
  }
  
  console.log('Thumbnail failed to load:', {
    originalThumbnail,
    itemUrl,
    currentSrc: img.src
  });
  
  // Try fallback URLs
  const fallbackUrls = [];
  
  // If we have an item URL, try generating image URLs from it
  if (itemUrl) {
    // Extract article ID from various Trove URL formats
    const articleIdMatch = itemUrl.match(/article\/(\d+)/) || 
                          itemUrl.match(/nla\.news-article(\d+)/) ||
                          itemUrl.match(/\/(\d{6,})/);
    const articleId = articleIdMatch ? articleIdMatch[1] : null;
    
    if (articleId) {
      // Try newspaper article image URLs
      fallbackUrls.push(
        `https://trove.nla.gov.au/newspaper/article/${articleId}/image?hei=180`,
        `https://trove.nla.gov.au/newspaper/article/${articleId}/image?hei=120`,
        `https://trove.nla.gov.au/newspaper/article/${articleId}/image`,
        `${itemUrl}/image?hei=180`,
        `${itemUrl}/image?hei=120`,
        `${itemUrl}/image`
      );
    } else {
      // Generic fallbacks
      fallbackUrls.push(
        `${itemUrl}/image?hei=180`,
        `${itemUrl}/image?hei=120`,
        `${itemUrl}/image`,
        `${itemUrl}?image=true`
      );
    }
  }
  
  // Try original thumbnail with different parameters if it's a Trove URL
  if (originalThumbnail && originalThumbnail.includes('trove.nla.gov.au')) {
    if (!originalThumbnail.includes('hei=')) {
      fallbackUrls.push(`${originalThumbnail}?hei=180`);
      fallbackUrls.push(`${originalThumbnail}?hei=120`);
    }
  }
  
  // Try next fallback URL
  let currentIndex = parseInt(img.dataset.fallbackIndex || '0');
  
  if (currentIndex < fallbackUrls.length) {
    const nextUrl = fallbackUrls[currentIndex];
    console.log(`Trying fallback thumbnail URL ${currentIndex + 1}/${fallbackUrls.length}:`, nextUrl);
    img.dataset.fallbackIndex = (currentIndex + 1).toString();
    img.src = nextUrl;
  } else {
    // All fallbacks exhausted, show placeholder
    console.log('All thumbnail fallbacks exhausted, showing placeholder');
    img.dataset.errorHandled = 'true';
    showThumbnailPlaceholder(img);
  }
}

function showThumbnailPlaceholder(img) {
  // Hide the broken image and show a placeholder icon
  img.style.display = 'none';
  const thumbnailDiv = img.closest('.result-thumbnail');
  if (thumbnailDiv && !thumbnailDiv.querySelector('.thumbnail-placeholder')) {
    const placeholder = document.createElement('div');
    placeholder.className = 'thumbnail-placeholder';
    placeholder.innerHTML = 'ğŸ“„';
    placeholder.style.cssText = 'display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 2em; color: #999; background: #f5f5f5;';
    thumbnailDiv.appendChild(placeholder);
  }
}

function handleThumbnailLoad(img) {
  // Successfully loaded - remove any loading indicators
  img.style.opacity = '1';
  img.dataset.loaded = 'true';
  console.log('Thumbnail loaded successfully:', img.src);
}

function selectResult(id) {
  selectedResultId = id;
  const drawer = document.getElementById('previewDrawer');
  const content = document.getElementById('drawerContent');
  
  // Show drawer
  drawer.classList.add('open');
  
  // Load preview (would fetch from API in production)
  content.innerHTML = '<p>Loading preview...</p>';
  
  // Fetch item details
  fetch(`/api/item/${id}`)
    .then(r => {
      if (!r.ok) {
        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      }
      return r.json();
    })
    .then(data => {
      // Track article for AI context
      trackArticle(data);
      
      // Build detailed preview with all available metadata
      const escapeHtml = (str) => (str || '').toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      const safeStr = (val) => escapeHtml(val || '');
      
      const previewContent = `
        <div class="preview-item" id="previewContent-${id}">
          <h4 class="preview-title">${safeStr(data.title || 'Untitled')}</h4>
          
          <div class="preview-metadata">
            ${data.date ? `<div class="meta-row"><strong>ğŸ“… Date:</strong> ${safeStr(data.date)}</div>` : ''}
            ${data.issued ? `<div class="meta-row"><strong>ğŸ“… Issued:</strong> ${safeStr(data.issued)}</div>` : ''}
            ${data.source ? `<div class="meta-row"><strong>ğŸ“° Source:</strong> ${safeStr(data.source)}</div>` : ''}
            ${data.publisher_or_source ? `<div class="meta-row"><strong>ğŸ¢ Publisher:</strong> ${safeStr(data.publisher_or_source)}</div>` : ''}
            ${data.newspaper ? `<div class="meta-row"><strong>ğŸ“° Newspaper:</strong> ${safeStr(data.newspaper)}</div>` : ''}
            ${data.category ? `<div class="meta-row"><strong>ğŸ“š Category:</strong> ${safeStr(data.category)}</div>` : ''}
            ${data.format ? `<div class="meta-row"><strong>ğŸ“„ Format:</strong> ${safeStr(data.format)}</div>` : ''}
            ${data.page ? `<div class="meta-row"><strong>ğŸ“„ Page:</strong> ${safeStr(data.page)}</div>` : ''}
            ${data.volume ? `<div class="meta-row"><strong>ğŸ“š Volume:</strong> ${safeStr(data.volume)}</div>` : ''}
            ${data.place ? `<div class="meta-row"><strong>ğŸ“ Place:</strong> ${safeStr(data.place)}</div>` : ''}
            ${data.l_place ? `<div class="meta-row"><strong>ğŸ“ Location:</strong> ${safeStr(data.l_place)}</div>` : ''}
            ${data.contributor ? `<div class="meta-row"><strong>âœï¸ Contributor:</strong> ${safeStr(data.contributor)}</div>` : ''}
            ${data.author ? `<div class="meta-row"><strong>âœï¸ Author:</strong> ${safeStr(data.author)}</div>` : ''}
            ${data.creator ? `<div class="meta-row"><strong>âœï¸ Creator:</strong> ${safeStr(data.creator)}</div>` : ''}
            ${data.subject ? `<div class="meta-row"><strong>ğŸ·ï¸ Subject:</strong> ${safeStr(data.subject)}</div>` : ''}
            ${data.keywords ? `<div class="meta-row"><strong>ğŸ·ï¸ Keywords:</strong> ${safeStr(data.keywords)}</div>` : ''}
            ${data.language ? `<div class="meta-row"><strong>ğŸŒ Language:</strong> ${safeStr(data.language)}</div>` : ''}
            ${data.trove_id ? `<div class="meta-row"><strong>ğŸ†” Trove ID:</strong> <code>${safeStr(data.trove_id)}</code></div>` : ''}
            ${data.id ? `<div class="meta-row"><strong>ğŸ†” ID:</strong> <code>${safeStr(data.id)}</code></div>` : ''}
            ${data.url ? `<div class="meta-row"><strong>ğŸ”— URL:</strong> <a href="${safeStr(data.url)}" target="_blank" rel="noopener">View on Trove â†—</a></div>` : ''}
            ${data.trove_url ? `<div class="meta-row"><strong>ğŸ”— Trove URL:</strong> <a href="${safeStr(data.trove_url)}" target="_blank" rel="noopener">View on Trove â†—</a></div>` : ''}
            ${data.views ? `<div class="meta-row"><strong>ğŸ‘ï¸ Views:</strong> ${data.views}</div>` : ''}
            ${data.relevance ? `<div class="meta-row"><strong>â­ Relevance:</strong> ${data.relevance}</div>` : ''}
          </div>
          
          ${data.description ? `<div class="preview-description"><strong>Description:</strong><p>${safeStr(data.description)}</p></div>` : ''}
          ${data.summary ? `<div class="preview-summary"><strong>Summary:</strong><p>${safeStr(data.summary)}</p></div>` : ''}
          ${data.snippet ? `<div class="preview-snippet"><strong>Excerpt:</strong><p>${safeStr(data.snippet)}</p></div>` : ''}
          ${data.text ? `<div class="preview-text"><strong>Full Text (preview):</strong><div class="text-preview">${safeStr(data.text.substring(0, 1000))}${data.text.length > 1000 ? '...' : ''}</div></div>` : ''}
          
          <div class="preview-actions">
            <button class="btn-preview-action btn-pin" onclick="togglePin('${id}', this)" title="Pin for citation" data-pinned="false">
              <span class="pin-icon">ğŸ“Œ</span> Pin
            </button>
            <button class="btn-preview-action btn-read-aloud" onclick="readAloudPreview('${id}')" title="Read Aloud (Space)">ğŸ”Š Read Aloud</button>
            <button class="btn-preview-action" onclick="openReader('${id}', '${safeStr(data.url || data.trove_url || '')}', '${safeStr((data.snippet || data.text || data.description || '').substring(0, 500))}', '${safeStr(data.title || '')}', '${safeStr(data.date || data.issued || '')}', '${safeStr(data.source || data.publisher_or_source || data.newspaper || '')}')">ğŸ“– Open Reader</button>
            <button class="btn-preview-action" onclick="addToCollection('${id}')">ğŸ“š Add to Collection</button>
            ${data.url || data.trove_url ? `<a href="${safeStr(data.url || data.trove_url)}" target="_blank" class="btn-preview-action" rel="noopener">ğŸ”— View on Trove</a>` : ''}
          </div>
        </div>
      `;
      content.innerHTML = previewContent;
    })
    .catch(err => {
      console.error('Error fetching item for preview:', err);
      content.innerHTML = `
        <div class="alert alert-error">
          <p>Error loading preview: ${err.message || 'Unknown error'}</p>
          <p><a href="/reader?id=${id}" class="btn-link">Open in Reader instead</a></p>
        </div>
      `;
    });
}

function closePreview() {
  document.getElementById('previewDrawer').classList.remove('open');
  selectedResultId = null;
}

function handleSearch(e) {
  // Natural language query processing could happen here
  return true; // Allow form submission
}

function addToCollection(id) {
  if (!id) {
    showToast('No item ID provided', 'error');
    return;
  }
  
  fetch('/api/collections/add', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({item_id: id})
  })
  .then(r => {
    if (!r.ok) {
      throw new Error(`HTTP ${r.status}: ${r.statusText}`);
    }
    return r.json();
  })
  .then(data => {
    if (data.ok) {
      showToast('Added to collection!', 'success');
    } else {
      showToast(data.error || 'Failed to add to collection', 'error');
    }
  })
  .catch(err => {
    console.error('Error adding to collection:', err);
    showToast('Error adding to collection: ' + err.message, 'error');
  });
}

// Track article when clicked/opened
function trackArticle(item) {
  if (!item || !item.id) return;
  
  fetch('/api/context/track', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      trove_id: item.id,
      title: item.title || '',
      date: item.date || '',
      source: item.source || '',
      url: item.url || '',
      snippet: item.snippet || ''
    })
  })
  .catch(err => {
    console.warn('Failed to track article:', err);
  });
}

// Toggle pin/unpin for citation
function togglePin(troveId, button) {
  const isPinned = button.dataset.pinned === 'true';
  const endpoint = isPinned ? `/api/context/unpin/${troveId}` : `/api/context/pin/${troveId}`;
  
  fetch(endpoint, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'}
  })
  .then(r => r.json())
  .then(data => {
    if (data.ok) {
      button.dataset.pinned = isPinned ? 'false' : 'true';
      button.classList.toggle('pinned', !isPinned);
      button.querySelector('.pin-icon').textContent = isPinned ? 'ğŸ“Œ' : 'ğŸ“Œâœ…';
      showToast(isPinned ? 'Unpinned' : 'Pinned for citation', 'success');
    } else {
      showToast('Failed to ' + (isPinned ? 'unpin' : 'pin') + ' article', 'error');
    }
  })
  .catch(err => {
    console.error('Error toggling pin:', err);
    showToast('Error: ' + err.message, 'error');
  });
}

function readAloudResult(itemId) {
  const resultCard = document.querySelector(`[data-id="${itemId}"]`);
  if (!resultCard) return;
  
  const title = resultCard.querySelector('.result-title')?.textContent || '';
  const snippet = resultCard.querySelector('.result-snippet')?.textContent || '';
  const date = resultCard.querySelector('.result-date')?.textContent || '';
  const source = resultCard.querySelector('.result-source')?.textContent || '';
  
  const text = [title, date, source, snippet].filter(Boolean).join('. ');
  
  const button = resultCard.querySelector('.btn-read-aloud');
  if (window.TTS) {
    window.TTS.toggle(text, button);
  }
}

function readAloudPreview(itemId) {
  const previewContent = document.getElementById(`previewContent-${itemId}`);
  if (!previewContent) return;
  
  // Extract all readable text, excluding action buttons and metadata labels
  const clone = previewContent.cloneNode(true);
  clone.querySelectorAll('.preview-actions, button, .meta-row strong, .preview-metadata strong').forEach(el => el.remove());
  const text = clone.innerText || clone.textContent || '';
  const button = previewContent.querySelector('.btn-read-aloud');
  if (window.TTS && text) {
    window.TTS.toggle(text, button);
  }
}

function openReader(id, url = '', snippet = '', title = '', date = '', source = '') {
  // Track article when opening reader
  trackArticle({id, url, snippet, title, date, source});
  
  const params = new URLSearchParams({id: id});
  if (url) params.set('url', url);
  if (snippet) params.set('snippet', snippet);
  if (title) params.set('title', title);
  if (date) params.set('date', date);
  if (source) params.set('source', source);
  window.location.href = `/reader?${params.toString()}`;
}

function submitFilters() {
  const form = document.getElementById('searchForm');
  if (!form) return;
  if (typeof form.requestSubmit === 'function') {
    form.requestSubmit();
  } else {
    form.submit();
  }
}

function applyFilterValue(inputId, value) {
  const input = document.getElementById(inputId);
  if (!input) return;
  input.value = value;
  submitFilters();
}

function applyFormat(value) {
  const select = document.getElementById('l_format');
  if (!select) return;
  select.value = value;
  submitFilters();
}

function applyDatePreset(fromYear, toYear) {
  const fromInput = document.getElementById('year_from');
  const toInput = document.getElementById('year_to');
  if (fromInput) {
    fromInput.value = fromYear || '';
  }
  if (toInput) {
    toInput.value = toYear || '';
  }
  submitFilters();
}

function switchCategory(category) {
  const categoryField = document.getElementById('categoryField');
  if (categoryField) {
    categoryField.value = category;
  }
  submitFilters();
}

function removeFilter(key) {
  switch (key) {
    case 'category': {
      const categoryField = document.getElementById('categoryField');
      if (categoryField) {
        categoryField.value = 'newspaper';
      }
      break;
    }
    case 'year':
      document.getElementById('year_from').value = '';
      document.getElementById('year_to').value = '';
      break;
    case 'l_place':
      document.getElementById('l_place').value = '';
      break;
    case 'publication':
      document.getElementById('publication').value = '';
      break;
    case 'l_format':
      document.getElementById('l_format').value = '';
      break;
    case 'people_orgs':
      document.getElementById('people_orgs').value = '';
      break;
    case 'keywords':
      document.getElementById('keywords').value = '';
      break;
    case 'sortby':
      document.getElementById('sortby').value = '';
      break;
    default:
      break;
  }
  submitFilters();
}

function clearAllFilters() {
  const categoryField = document.getElementById('categoryField');
  if (categoryField) {
    categoryField.value = 'newspaper';
  }
  document.getElementById('year_from').value = '';
  document.getElementById('year_to').value = '';
  document.getElementById('l_place').value = '';
  document.getElementById('publication').value = '';
  document.getElementById('l_format').value = '';
  document.getElementById('people_orgs').value = '';
  document.getElementById('keywords').value = '';
  document.getElementById('sortby').value = '';
  submitFilters();
}

function showQuickChips(containerId) {
  const container = document.getElementById(containerId);
  if (container) {
    container.style.display = 'block';
  }
}

function hideQuickChips(containerId) {
  const container = document.getElementById(containerId);
  if (container) {
    // Only hide if not hovering over chips
    const isHovering = container.matches(':hover') || container.querySelector(':hover');
    if (!isHovering) {
      container.style.display = 'none';
    }
  }
}

function expandChips(containerId, totalCount) {
  // This would show all chips - for now just keep showing the container
  const container = document.getElementById(containerId);
  if (container) {
    container.style.display = 'block';
  }
}

function toggleFilterSection(button) {
  const section = button.closest('.filter-section-collapsible');
  const content = section.querySelector('.filter-section-content');
  const icon = button.querySelector('.toggle-icon');
  const isExpanded = button.getAttribute('aria-expanded') === 'true';
  
  if (isExpanded) {
    content.style.display = 'none';
    icon.textContent = 'â–¼';
    button.setAttribute('aria-expanded', 'false');
  } else {
    content.style.display = 'block';
    icon.textContent = 'â–²';
    button.setAttribute('aria-expanded', 'true');
  }
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Space key: Toggle read aloud on selected result (if not in input field)
  if (e.key === ' ' && !e.target.matches('input, textarea, [contenteditable]')) {
    if (selectedResultId) {
      e.preventDefault();
      // Try preview drawer first, then result card
      const previewContent = document.getElementById(`previewContent-${selectedResultId}`);
      if (previewContent && previewContent.closest('.preview-drawer.open')) {
        readAloudPreview(selectedResultId);
      } else {
        readAloudResult(selectedResultId);
      }
    }
  }
  
  if (e.key === 'r' && selectedResultId) {
    e.preventDefault();
    const resultCard = document.querySelector(`[data-id="${selectedResultId}"]`);
    if (resultCard) {
      const item = {
        id: selectedResultId,
        url: resultCard.querySelector('a[href*="trove"]')?.href || '',
        snippet: resultCard.querySelector('.result-snippet')?.textContent || '',
        title: resultCard.querySelector('.result-title')?.textContent || '',
        date: resultCard.querySelector('.result-date')?.textContent.replace('ğŸ“… ', '') || '',
        source: resultCard.querySelector('.result-source')?.textContent.replace('ğŸ“° ', '') || '',
      };
      openReader(item.id, item.url, item.snippet, item.title, item.date, item.source);
    }
  }
  if (e.key === 'c' && selectedResultId) {
    e.preventDefault();
    addToCollection(selectedResultId);
  }
  if (e.key === 'Escape') {
    closePreview();
    window.TTS.stop();
  }
});
</script>
{% endblock %}

